<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de corte CNC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1 {
      text-align: center;
      color: #333;
    }

     label {
      display: block;
      margin-top: 10px;
      color: #555;
      position: relative;
      padding-left: 25px; /* Espaço para o ícone */
    }

    label i {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      color: #007bff; /* Cor do ícone */
    }

    input, select, textarea { /* Adicionado textarea aqui */
      width: 100%;
      max-width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    /* Estilo específico para agrupar Serviço Adicional */
    .service-group {
      display: flex;
      gap: 10px; /* Espaço entre os campos */
      align-items: flex-end; /* Alinhar a base dos inputs */
    }
    .service-group label {
        flex-grow: 1;
        padding-left: 0; /* Remover padding do label para alinhamento */
    }
    .service-group label i {
        position: static; /* Remover posicionamento absoluto */
        transform: none; /* Remover transformação */
        margin-right: 5px; /* Espaço entre ícone e texto */
    }
    .service-group input {
        flex-grow: 1;
    }
    .service-group .service-value {
        width: 120px; /* Largura fixa para o campo de valor */
        flex-grow: 0;
    }

    /* Estilos para os blocos de material dinâmicos */
    .material-block {
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #fcfcfc;
    }
    .material-block h3 {
        margin-top: 0;
        color: #007bff;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .material-block .remove-material-block-btn {
        background-color: #dc3545;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        width: auto; /* Para não ocupar 100% da largura */
        margin-top: 10px;
        align-self: flex-end; /* Alinhar à direita */
    }
    .material-block .remove-material-block-btn:hover {
        background-color: #c82333;
    }


    button {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .result {
      margin-top: 20px;
      padding: 10px;
      background-color: #e9ecef;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Calculadora de corte CNC</h1>

    <div id="material-blocks-container">
      <div class="material-block" id="material-block-0">
        <h3>Item <span class="item-number">1</span></h3>
        <label for="material_0"><i class="fas fa-box"></i> Material:</label>
        <select id="material_0" class="material-select" onchange="updateMaterialInfo(this)">
          <option value="MDF_de_18mm">MDF de 18mm - 2750x1850mm (R$ 285,00)</option>
          <option value="MDF_de_6mm">MDF de 6mm - 2750x1850mm (R$ 150,00)</option>
          <option value="MDF_de_3mm">MDF de 3mm - 2750x1850mm (R$ 95,00)</option>
          <option value="Madeira">Madeira - 2500x1500mm (R$ 320,00)</option>
          <option value="ACM">ACM 3mm - 5000x1500mm (R$ 700,00)</option>
          <option value="PVC_Expandido_de_25mm">PVC Expandido de 25mm - 2000x1000mm (R$ 750,00)</option>
          <option value="Acrilico">Acrílico - 2000x1500mm (R$ 380,00)</option>
        </select>

        <label for="width_0"><i class="fas fa-ruler-horizontal"></i> Largura (mm):</label>
        <input type="number" id="width_0" class="width-input" placeholder="Insira a largura">

        <label for="height_0"><i class="fas fa-ruler-vertical"></i> Altura (mm):</label>
        <input type="number" id="height_0" class="height-input" placeholder="Insira a altura">

        <label for="quantity_0"><i class="fas fa-layer-group"></i> Quantidade de Peças:</label>
        <input type="number" id="quantity_0" class="quantity-input" value="1" min="1">

        </div>
    </div>

    <button type="button" onclick="addMaterialBlock()" style="margin-bottom: 20px;">Adicionar Novo Item</button>


    <label for="cutPrice"><i class="fas fa-cut"></i> Valor do corte CNC por m² (R$):</label>
    <input type="number" id="cutPrice" placeholder="Insira o valor do corte" value="50">

    <label for="sandingCost"><i class="fas fa-brush"></i> Custo de Lixamento (R$):</label>
    <input type="number" id="sandingCost" placeholder="Opcional">

    <label for="finishingCost"><i class="fas fa-paint-roller"></i> Custo de Acabamento (R$):</label>
    <input type="number" id="finishingCost" placeholder="Opcional">

    <label for="shippingCost"><i class="fas fa-truck"></i> Custo de Frete (R$):</label>
    <input type="number" id="shippingCost" placeholder="Opcional">
    
    <label for="discountPercentage"><i class="fas fa-percent"></i> Desconto (%):</label>
    <input type="number" id="discountPercentage" placeholder="Opcional (ex: 10 para 10%)">

    <label for="additionalServiceName"><i class="fas fa-plus-circle"></i> Serviço Adicional:</label>
    <div class="service-group">
        <input type="text" id="additionalServiceName" placeholder="Descrição do serviço (opcional)">
        <input type="number" id="additionalServiceValue" class="service-value" placeholder="Valor (R$)" value="0">
    </div>

    <label for="additionalInfo"><i class="fas fa-info-circle"></i> Informações Adicionais:</label>
    <textarea id="additionalInfo" placeholder="Qualquer informação extra que queira adicionar (opcional)" rows="4"></textarea>

    <label for="clientName"><i class="fas fa-user"></i> Nome do Cliente:</label>
    <input type="text" id="clientName" placeholder="Insira o nome do cliente">

    <label for="clientContact"><i class="fas fa-phone"></i> Contato do Cliente:</label>
    <input type="text" id="clientContact" placeholder="(00) 00000-0000" oninput="formatPhone(this)">

    <button onclick="calculateMaterial()">Calcular</button>

    <div class="result" id="result"></div>

    <button id="generatePDF" onclick="generatePDF()" style="display:none;">Gerar PDF</button>
  </div>

<script>
    const materialData = {
        MDF_de_18mm: { largura: 2750, altura: 1850, preco: 285.00, peso: 68.3 },
        MDF_de_6mm: { largura: 2750, altura: 1850, preco: 150.00, peso: 40.0 },
        MDF_de_3mm: { largura: 2750, altura: 1850, preco: 95.00, peso: 30.0 },
        Madeira: { largura: 2500, altura: 1500, preco: 320.00, peso: 50.0 },
        ACM: { largura: 5000, altura: 1500, preco: 700.00, peso: 60.0 },
        PVC_Expandido_de_25mm: { largura: 2000, altura: 1000.00, preco: 750, peso: 45.0 },
        Acrilico: { largura: 2000, altura: 1500, preco: 380.00, peso: 35.0 }
    };

    let allCalculatedItems = []; // Armazena os detalhes de cada item calculado
    let additionalInfoText = '';
    let finalCalculatedTotal = 0; // Armazena o valor total final numérico
    let itemCounter = 0; // Contador para IDs únicas dos blocos de material

    // Função para atualizar os placeholders de largura/altura com base no material selecionado
    function updateMaterialInfo(selectElement) {
        const material = selectElement.value;
        const materialInfo = materialData[material];
        
        // Encontra o bloco pai do selectElement
        const materialBlock = selectElement.closest('.material-block');
        if (materialBlock) {
            const widthInput = materialBlock.querySelector('.width-input');
            const heightInput = materialBlock.querySelector('.height-input');

            if (widthInput) {
                widthInput.placeholder = `Largura máxima: ${materialInfo.largura} mm`;
            }
            if (heightInput) {
                heightInput.placeholder = `Altura máxima: ${materialInfo.altura} mm`;
            }
        }
    }

    // Função para adicionar um novo bloco de material
    function addMaterialBlock() {
        itemCounter++;
        const container = document.getElementById('material-blocks-container');
        const originalBlock = document.getElementById('material-block-0'); // Usamos o primeiro como template

        // Clonar o bloco original para criar um novo
        const newBlock = originalBlock.cloneNode(true);
        newBlock.id = `material-block-${itemCounter}`;
        newBlock.querySelector('.item-number').innerText = itemCounter + 1; // Atualiza o número do item

        // Limpar os valores dos inputs do novo bloco
        const inputs = newBlock.querySelectorAll('input, select');
        inputs.forEach(input => {
            const oldId = input.id;
            input.id = oldId.replace(/_\d+$/, `_${itemCounter}`); // Atualiza o ID
            input.name = input.id; // Atualiza o name (importante para formulários)
            if (input.type === 'number') {
                input.value = ''; // Limpa o valor numérico
                if (input.classList.contains('quantity-input')) {
                    input.value = '1'; // Reseta a quantidade para 1
                }
            } else if (input.tagName === 'SELECT') {
                input.value = originalBlock.querySelector('.material-select').value; // Mantém o material padrão
                input.onchange = function() { updateMaterialInfo(this); }; // Reconecta o evento onchange
            }
        });
        
        // Adicionar botão de remover ao novo bloco
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.classList.add('remove-material-block-btn');
        removeButton.innerText = 'Remover Item';
        removeButton.onclick = function() { removeMaterialBlock(this); };
        newBlock.querySelector('h3').appendChild(removeButton); // Adiciona o botão ao h3 para alinhamento

        container.appendChild(newBlock);

        // Atualizar placeholders do novo bloco
        updateMaterialInfo(newBlock.querySelector('.material-select'));
    }

    // Função para remover um bloco de material
    function removeMaterialBlock(buttonElement) {
        const blockToRemove = buttonElement.closest('.material-block');
        blockToRemove.remove();
        // Reajustar os números dos itens visíveis
        const itemNumbers = document.querySelectorAll('.item-number');
        itemNumbers.forEach((span, index) => {
            span.innerText = index + 1;
        });
        // Recalcular para atualizar o resultado após remoção
        calculateMaterial();
    }


    function calculateMaterial() {
        let totalPrecoMaterialGeral = 0;
        let totalPrecoCorteGeral = 0;
        let totalAreaUsadaGeral = 0;
        let totalPesoCalculadoGeral = 0;
        allCalculatedItems = []; // Limpa a lista de itens calculados a cada novo cálculo

        const materialBlocks = document.querySelectorAll('.material-block');

        // Loop por cada bloco de material
        materialBlocks.forEach((block, index) => {
            const material = block.querySelector('.material-select').value;
            const materialInfo = materialData[material];
            const inputLargura = parseFloat(block.querySelector('.width-input').value);
            const inputAltura = parseFloat(block.querySelector('.height-input').value);
            const quantity = parseInt(block.querySelector('.quantity-input').value) || 1; // Quantidade de peças

            // Verifica se as dimensões são válidas para o material atual
            if (
                !isNaN(inputLargura) && 
                !isNaN(inputAltura) && 
                inputLargura > 0 && 
                inputAltura > 0 && 
                inputLargura <= materialInfo.largura && 
                inputAltura <= materialInfo.altura
            ) {
                const areaChapa = (materialInfo.largura * materialInfo.altura) / 1000000;
                const areaUsadaPorPeca = (inputLargura * inputAltura) / 1000000;
                const areaUsadaTotalItem = areaUsadaPorPeca * quantity; // Área total para este item
                
                // Calcula quantas chapas deste material são necessárias para este item
                const sheetsNeededForThisItem = Math.ceil(areaUsadaTotalItem / areaChapa);
                const precoMaterialItem = sheetsNeededForThisItem * materialInfo.preco;

                const precoCortePorMetroQuadrado = parseFloat(document.getElementById('cutPrice').value);
                const precoCorteItem = areaUsadaTotalItem * precoCortePorMetroQuadrado;

                const pesoPorM2 = materialInfo.peso / areaChapa;
                const pesoCalculadoItem = areaUsadaTotalItem * pesoPorM2;

                allCalculatedItems.push({
                    itemNumber: index + 1,
                    material: material,
                    largura: inputLargura,
                    altura: inputAltura,
                    quantity: quantity,
                    areaUsada: areaUsadaTotalItem,
                    sheetsNeeded: sheetsNeededForThisItem,
                    precoMaterial: precoMaterialItem,
                    precoCorte: precoCorteItem,
                    peso: pesoCalculadoItem
                });

                totalPrecoMaterialGeral += precoMaterialItem;
                totalPrecoCorteGeral += precoCorteItem;
                totalAreaUsadaGeral += areaUsadaTotalItem;
                totalPesoCalculadoGeral += pesoCalculadoItem;

            } else {
                document.getElementById('result').innerHTML = `Erro no Item ${index + 1}: Por favor, insira dimensões válidas dentro dos limites do material selecionado.`;
                document.getElementById('generatePDF').style.display = 'none';
                return; // Para a execução se houver erro em algum item
            }
        });

        // Captura os custos adicionais e descontos globais
        const sandingCost = parseFloat(document.getElementById('sandingCost').value) || 0;
        const finishingCost = parseFloat(document.getElementById('finishingCost').value) || 0;
        const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
        const discountPercentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
        const additionalServiceName = document.getElementById('additionalServiceName').value.trim();
        const additionalServiceValue = parseFloat(document.getElementById('additionalServiceValue').value) || 0;
        const nomeCliente = document.getElementById('clientName').value;
        const contatoCliente = document.getElementById('clientContact').value;
        additionalInfoText = document.getElementById('additionalInfo').value.trim();


        // Subtotal para cálculo do desconto (exclui o frete)
        let subtotalForDiscount = totalPrecoMaterialGeral + totalPrecoCorteGeral + sandingCost + finishingCost + additionalServiceValue;

        let discountAmount = 0;
        if (discountPercentage > 0) {
            discountAmount = subtotalForDiscount * (discountPercentage / 100);
        }

        // Preço total final (aplica o desconto e depois adiciona o frete)
        let subtotalFinal = (subtotalForDiscount - discountAmount) + shippingCost;
        finalCalculatedTotal = subtotalFinal; // Armazena o valor numérico total

        let resultHtml = "";

        // Detalhes por item
        allCalculatedItems.forEach(item => {
            resultHtml += `<h3>Item ${item.itemNumber} - ${item.material.replace(/_/g, ' ')}:</h3>`;
            resultHtml += `Dimensões: ${item.largura}mm x ${item.altura}mm (${item.quantity} un)<br>`;
            resultHtml += `Área Total Item: ${item.areaUsada.toFixed(4)} m²<br>`;
            resultHtml += `Chap. Necessárias: ${item.sheetsNeeded}<br>`;
            resultHtml += `Custo Material Item: R$ ${item.precoMaterial.toFixed(2)}<br>`;
            resultHtml += `Custo Corte Item: R$ ${item.precoCorte.toFixed(2)}<br>`;
            resultHtml += `Peso Estimado Item: ${item.peso.toFixed(2)} kg<br><br>`;
        });

        // Totais gerais
        resultHtml += `<h2>Resumo Geral:</h2>`;
        resultHtml += `Área Total de Corte: ${totalAreaUsadaGeral.toFixed(4)} m²<br>`;
        resultHtml += `Peso Total Estimado: ${totalPesoCalculadoGeral.toFixed(2)} kg<br>`;
        resultHtml += `Custo Total de Materiais: R$ ${totalPrecoMaterialGeral.toFixed(2)}<br>`;
        resultHtml += `Custo Total de Cortes: R$ ${totalPrecoCorteGeral.toFixed(2)}<br>`;

        if (sandingCost > 0) {
            resultHtml += `Custo de Lixamento: R$ ${sandingCost.toFixed(2)}<br>`;
        }
        if (finishingCost > 0) {
            resultHtml += `Custo de Acabamento: R$ ${finishingCost.toFixed(2)}<br>`;
        }
        if (additionalServiceValue > 0 || additionalServiceName) {
            const serviceLabel = additionalServiceName ? `Serv. Adicional (${additionalServiceName})` : 'Serviço Adicional';
            resultHtml += `${serviceLabel}: R$ ${additionalServiceValue.toFixed(2)}<br>`;
        }
        if (discountPercentage > 0) {
            resultHtml += `Desconto (${discountPercentage.toFixed(2)}%): -R$ ${discountAmount.toFixed(2)}<br>`;
        }
        if (shippingCost > 0) {
            resultHtml += `Custo de Frete: R$ ${shippingCost.toFixed(2)}<br>`;
        }

        resultHtml += `<b>PREÇO TOTAL FINAL: R$ ${finalCalculatedTotal.toFixed(2)}</b><br><br>`;

        if (additionalInfoText) {
            resultHtml += `<b>Informações Adicionais:</b><br>${additionalInfoText.replace(/\n/g, "<br>")}<br><br>`;
        }

        resultHtml += `<b>Cliente:</b> ${nomeCliente}<br><b>Contato:</b> ${contatoCliente}`;


        document.getElementById('result').innerHTML = resultHtml;
        document.getElementById('generatePDF').style.display = 'block';
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const dataOrcamento = new Date();
        const diaOrcamento = String(dataOrcamento.getDate()).padStart(2, '0');
        const mesOrcamento = String(dataOrcamento.getMonth() + 1).padStart(2, '0');
        const anoOrcamento = dataOrcamento.getFullYear();
        const dataFormatadaOrcamento = `${diaOrcamento}/${mesOrcamento}/${anoOrcamento}`;

        const dataExpiracao = new Date();
        dataExpiracao.setDate(dataOrcamento.getDate() + 15);
        const diaExpiracao = String(dataExpiracao.getDate()).padStart(2, '0');
        const mesExpiracao = String(dataExpiracao.getMonth() + 1).padStart(2, '0');
        const anoExpiracao = dataExpiracao.getFullYear();
        const dataFormatadaExpiracao = `${diaExpiracao}/${mesExpiracao}/${anoOrcamento}`;

        let clientName = document.getElementById('clientName').value.trim();
        let fileName = "orcamento_corte_CNC.pdf";

        if (clientName) {
            clientName = clientName.replace(/[^a-zA-Z0-9 ]/g, "").replace(/ /g, "_");
            fileName = `${clientName}_orcamento_CNC.pdf`;
        }

        const logoImg = new Image();
        logoImg.src = 'logo-calculadora1.png'; // Verifique se este nome está correto no seu GitHub!

        logoImg.onload = () => {
            doc.addImage(logoImg, 'PNG', 10, 10, 50, 20);

            // Informações da Empresa (ao lado do logo)
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const empresaInfoX = 70;
            let empresaInfoY = 15;

            doc.text("Site: www.vetorcut.com.br", empresaInfoX, empresaInfoY);
            empresaInfoY += 5;
            doc.text("Atendente: Jefferson Machado", empresaInfoX, empresaInfoY);
            empresaInfoY += 5;
            doc.text("WhatsApp: (51) 9 2003-9698", empresaInfoX, empresaInfoY);


            let yPos = 40;

            doc.setFontSize(16);
            doc.text("Orçamento de Corte CNC", 10, yPos);
            yPos += 10;

            doc.setFontSize(12);
            doc.text(`Data do Orçamento: ${dataFormatadaOrcamento}`, 10, yPos);
            yPos += 7;
            doc.text(`Expira em: ${dataFormatadaExpiracao}`, 10, yPos);
            yPos += 10;

            doc.setFontSize(11);
            const col1X = 15;
            const col2X = 185;

            // Detalhes por item no PDF
            allCalculatedItems.forEach(item => {
                doc.setFont(undefined, 'bold');
                doc.text(`Item ${item.itemNumber} - ${item.material.replace(/_/g, ' ')}:`, col1X, yPos);
                yPos += 7;
                doc.setFont(undefined, 'normal');
                doc.text(`Dimensões: ${item.largura}mm x ${item.altura}mm (${item.quantity} un)`, col1X + 5, yPos);
                yPos += 7;
                doc.text(`Área Total Item: ${item.areaUsada.toFixed(4)} m²`, col1X + 5, yPos);
                yPos += 7;
                doc.text(`Chap. Necessárias: ${item.sheetsNeeded}`, col1X + 5, yPos);
                yPos += 7;
                doc.text(`Custo Material Item: R$ ${item.precoMaterial.toFixed(2)}`, col1X + 5, yPos);
                yPos += 7;
                doc.text(`Custo Corte Item: R$ ${item.precoCorte.toFixed(2)}`, col1X + 5, yPos);
                yPos += 7;
                doc.text(`Peso Estimado Item: ${item.peso.toFixed(2)} kg`, col1X + 5, yPos);
                yPos += 10; // Espaço entre os itens
            });

            // Linha separadora antes dos totais
            doc.line(col1X, yPos - 3, col2X, yPos - 3);
            yPos += 2; // Ajuste de espaço após a linha

            // Totais gerais no PDF
            let totalAreaUsadaGeralPDF = 0;
            let totalPesoCalculadoGeralPDF = 0;
            let totalPrecoMaterialGeralPDF = 0;
            let totalPrecoCorteGeralPDF = 0;

            allCalculatedItems.forEach(item => {
                totalAreaUsadaGeralPDF += item.areaUsada;
                totalPesoCalculadoGeralPDF += item.peso;
                totalPrecoMaterialGeralPDF += item.precoMaterial;
                totalPrecoCorteGeralPDF += item.precoCorte;
            });


            doc.setFont(undefined, 'normal');
            doc.text(`Área Total de Corte: ${totalAreaUsadaGeralPDF.toFixed(4)} m²`, col1X, yPos);
            yPos += 7;
            doc.text(`Peso Total Estimado: ${totalPesoCalculadoGeralPDF.toFixed(2)} kg`, col1X, yPos);
            yPos += 7;
            doc.text(`Custo Total de Materiais: R$ ${totalPrecoMaterialGeralPDF.toFixed(2)}`, col1X, yPos);
            yPos += 7;
            doc.text(`Custo Total de Cortes: R$ ${totalPrecoCorteGeralPDF.toFixed(2)}`, col1X, yPos);
            yPos += 7;

            const sandingCost = parseFloat(document.getElementById('sandingCost').value) || 0;
            const finishingCost = parseFloat(document.getElementById('finishingCost').value) || 0;
            const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discountPercentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
            const additionalServiceName = document.getElementById('additionalServiceName').value.trim();
            const additionalServiceValue = parseFloat(document.getElementById('additionalServiceValue').value) || 0;

            if (sandingCost > 0) {
                doc.text(`Custo de Lixamento: R$ ${sandingCost.toFixed(2)}`, col1X, yPos);
                yPos += 7;
            }
            if (finishingCost > 0) {
                doc.text(`Custo de Acabamento: R$ ${finishingCost.toFixed(2)}`, col1X, yPos);
                yPos += 7;
            }
            if (additionalServiceValue > 0 || additionalServiceName) {
                const serviceLabel = additionalServiceName ? `Serv. Adicional (${additionalServiceName})` : 'Serviço Adicional';
                doc.text(`${serviceLabel}: R$ ${additionalServiceValue.toFixed(2)}`, col1X, yPos);
                yPos += 7;
            }

            let subtotalForDiscountPDF = totalPrecoMaterialGeralPDF + totalPrecoCorteGeralPDF + sandingCost + finishingCost + additionalServiceValue;
            let discountAmountPDF = 0;
            if (discountPercentage > 0) {
                discountAmountPDF = subtotalForDiscountPDF * (discountPercentage / 100);
                doc.text(`Desconto (${discountPercentage.toFixed(2)}%): -R$ ${discountAmountPDF.toFixed(2)}`, col1X, yPos);
                yPos += 7;
            }

            if (shippingCost > 0) {
                doc.text(`Custo de Frete: R$ ${shippingCost.toFixed(2)}`, col1X, yPos);
                yPos += 7;
            }

            doc.setFont(undefined, 'bold');
            doc.text("PREÇO TOTAL FINAL:", col1X, yPos);
            doc.text(`R$ ${finalCalculatedTotal.toFixed(2)}`, col2X, yPos, { align: "right" });
            yPos += 10;


            if (additionalInfoText) {
                yPos += 5;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Informações Adicionais:", 10, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 7;
                const additionalInfoLines = doc.splitTextToSize(additionalInfoText, 180);
                additionalInfoLines.forEach(line => {
                    doc.text(line, 10, yPos);
                    yPos += 7;
                });
            }

            const nomeCliente = document.getElementById('clientName').value;
            const contatoCliente = document.getElementById('clientContact').value;

            yPos += 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Cliente:", 10, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(nomeCliente, 30, yPos);
            yPos += 7;
            doc.setFont(undefined, 'bold');
            doc.text("Contato:", 10, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contatoCliente, 30, yPos);

            doc.save(fileName);
        };

        // Fallback para quando a imagem não carrega
        logoImg.onerror = () => {
            // Lógica de fallback similar à do onload, mas sem a imagem
            // Para manter o código conciso, não vou repetir toda a estrutura aqui,
            // mas seria o mesmo conteúdo de geração de PDF iniciando de um yPos mais alto.
            // Para este exemplo, manterei a lógica de salvamento simples como fallback.
            const docFallback = new jsPDF();
            docFallback.setFontSize(12);
            let yPosFallback = 10; // Posição inicial para o texto sem logo

            docFallback.setFontSize(10);
            docFallback.setFont(undefined, 'normal');
            const empresaInfoX = 70; // Mantém a posição se a intenção é ter um "espaço" de logo
            let empresaInfoY = 15;

            docFallback.text("Site: www.vetorcut.com.br", empresaInfoX, empresaInfoY);
            empresaInfoY += 5;
            docFallback.text("Atendente: Jefferson Machado", empresaInfoX, empresaInfoY);
            empresaInfoY += 5;
            docFallback.text("WhatsApp: (51) 9 2003-9698", empresaInfoX, empresaInfoY);

            yPosFallback = 40;
            docFallback.setFontSize(16);
            docFallback.text("Orçamento de Corte CNC", 10, yPosFallback);
            yPosFallback += 10;

            docFallback.setFontSize(12);
            docFallback.text(`Data do Orçamento: ${dataFormatadaOrcamento}`, 10, yPosFallback);
            yPosFallback += 7;
            docFallback.text(`Expira em: ${dataFormatadaExpiracao}`, 10, yPosFallback);
            yPosFallback += 10;

            docFallback.setFontSize(11);
            const col1X = 15;
            const col2X = 185;

            // Detalhes por item no PDF (fallback)
            allCalculatedItems.forEach(item => {
                docFallback.setFont(undefined, 'bold');
                docFallback.text(`Item ${item.itemNumber} - ${item.material.replace(/_/g, ' ')}:`, col1X, yPosFallback);
                yPosFallback += 7;
                docFallback.setFont(undefined, 'normal');
                docFallback.text(`Dimensões: ${item.largura}mm x ${item.altura}mm (${item.quantity} un)`, col1X + 5, yPosFallback);
                yPosFallback += 7;
                docFallback.text(`Área Total Item: ${item.areaUsada.toFixed(4)} m²`, col1X + 5, yPosFallback);
                yPosFallback += 7;
                docFallback.text(`Chap. Necessárias: ${item.sheetsNeeded}`, col1X + 5, yPosFallback);
                yPosFallback += 7;
                docFallback.text(`Custo Material Item: R$ ${item.precoMaterial.toFixed(2)}`, col1X + 5, yPosFallback);
                yPosFallback += 7;
                docFallback.text(`Custo Corte Item: R$ ${item.precoCorte.toFixed(2)}`, col1X + 5, yPosFallback);
                yPosFallback += 7;
                docFallback.text(`Peso Estimado Item: ${item.peso.toFixed(2)} kg`, col1X + 5, yPosFallback);
                yPosFallback += 10;
            });

            docFallback.line(col1X, yPosFallback - 3, col2X, yPosFallback - 3);
            yPosFallback += 2;

            let totalAreaUsadaGeralFallback = 0;
            let totalPesoCalculadoGeralFallback = 0;
            let totalPrecoMaterialGeralFallback = 0;
            let totalPrecoCorteGeralFallback = 0;

            allCalculatedItems.forEach(item => {
                totalAreaUsadaGeralFallback += item.areaUsada;
                totalPesoCalculadoGeralFallback += item.peso;
                totalPrecoMaterialGeralFallback += item.precoMaterial;
                totalPrecoCorteGeralFallback += item.precoCorte;
            });

            docFallback.setFont(undefined, 'normal');
            docFallback.text(`Área Total de Corte: ${totalAreaUsadaGeralFallback.toFixed(4)} m²`, col1X, yPosFallback);
            yPosFallback += 7;
            docFallback.text(`Peso Total Estimado: ${totalPesoCalculadoGeralFallback.toFixed(2)} kg`, col1X, yPosFallback);
            yPosFallback += 7;
            docFallback.text(`Custo Total de Materiais: R$ ${totalPrecoMaterialGeralFallback.toFixed(2)}`, col1X, yPosFallback);
            yPosFallback += 7;
            docFallback.text(`Custo Total de Cortes: R$ ${totalPrecoCorteGeralGeralFallback.toFixed(2)}`, col1X, yPosFallback);
            yPosFallback += 7;

            const sandingCostFallback = parseFloat(document.getElementById('sandingCost').value) || 0;
            const finishingCostFallback = parseFloat(document.getElementById('finishingCost').value) || 0;
            const shippingCostFallback = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discountPercentageFallback = parseFloat(document.getElementById('discountPercentage').value) || 0;
            const additionalServiceNameFallback = document.getElementById('additionalServiceName').value.trim();
            const additionalServiceValueFallback = parseFloat(document.getElementById('additionalServiceValue').value) || 0;

            if (sandingCostFallback > 0) {
                docFallback.text(`Custo de Lixamento: R$ ${sandingCostFallback.toFixed(2)}`, col1X, yPosFallback);
                yPosFallback += 7;
            }
            if (finishingCostFallback > 0) {
                docFallback.text(`Custo de Acabamento: R$ ${finishingCostFallback.toFixed(2)}`, col1X, yPosFallback);
                yPosFallback += 7;
            }
            if (additionalServiceValueFallback > 0 || additionalServiceNameFallback) {
                const serviceLabel = additionalServiceNameFallback ? `Serv. Adicional (${additionalServiceNameFallback})` : 'Serviço Adicional';
                docFallback.text(`${serviceLabel}: R$ ${additionalServiceValueFallback.toFixed(2)}`, col1X, yPosFallback);
                yPosFallback += 7;
            }

            let subtotalForDiscountFallback = totalPrecoMaterialGeralFallback + totalPrecoCorteGeralFallback + sandingCostFallback + finishingCostFallback + additionalServiceValueFallback;
            let discountAmountFallback = 0;
            if (discountPercentageFallback > 0) {
                discountAmountFallback = subtotalForDiscountFallback * (discountPercentageFallback / 100);
                docFallback.text(`Desconto (${discountPercentageFallback.toFixed(2)}%): -R$ ${discountAmountFallback.toFixed(2)}`, col1X, yPosFallback);
                yPosFallback += 7;
            }

            if (shippingCostFallback > 0) {
                docFallback.text(`Custo de Frete: R$ ${shippingCostFallback.toFixed(2)}`, col1X, yPosFallback);
                yPosFallback += 7;
            }

            docFallback.setFont(undefined, 'bold');
            docFallback.text("PREÇO TOTAL FINAL:", col1X, yPosFallback);
            docFallback.text(`R$ ${finalCalculatedTotal.toFixed(2)}`, col2X, yPosFallback, { align: "right" });
            yPosFallback += 10;

            if (additionalInfoText) {
                yPosFallback += 5;
                docFallback.setFontSize(12);
                docFallback.setFont(undefined, 'bold');
                docFallback.text("Informações Adicionais:", 10, yPosFallback);
                docFallback.setFont(undefined, 'normal');
                yPosFallback += 7;
                const additionalInfoLines = docFallback.splitTextToSize(additionalInfoText, 180);
                additionalInfoLines.forEach(line => {
                    docFallback.text(line, 10, yPosFallback);
                    yPosFallback += 7;
                });
            }

            const nomeClienteFallback = document.getElementById('clientName').value;
            const contatoClienteFallback = document.getElementById('clientContact').value;

            yPosFallback += 10;
            docFallback.setFontSize(12);
            docFallback.setFont(undefined, 'bold');
            docFallback.text("Cliente:", 10, yPosFallback);
            docFallback.setFont(undefined, 'normal');
            docFallback.text(nomeClienteFallback, 30, yPosFallback);
            yPosFallback += 7;
            docFallback.setFont(undefined, 'bold');
            docFallback.text("Contato:", 10, yPosFallback);
            docFallback.setFont(undefined, 'normal');
            docFallback.text(contatoClienteFallback, 30, yPosFallback);

            docFallback.save(fileName);
        };
    }

    function formatPhone(input) {
        const phone = input.value.replace(/\D/g, '');
        if (phone.length <= 10) {
            input.value = phone.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else {
            input.value = phone.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
        }
    }

    // Inicializa o placeholder para o primeiro bloco ao carregar a página
    window.onload = function() {
        updateMaterialInfo(document.getElementById('material_0'));
    };
</script>

</body>
</html>
